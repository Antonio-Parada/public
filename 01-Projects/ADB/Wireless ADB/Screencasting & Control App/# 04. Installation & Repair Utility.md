# 04. Installation & Repair Utility

## The "Omarchy Doctor" Script
This script (`setup.sh`) serves two purposes:
1.  **Initial Install:** Checks for missing Arch packages (`pacman`) and installs them.
2.  **System Repair:** Fixes broken symlinks, restores missing config files, and verifies permissions.

This script should be saved as `setup.sh` within the main project directory.

```bash
#!/bin/bash
# Omarchy Android Subsystem - Setup & Repair
# Usage: ./setup.sh

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}=== Omarchy Android Setup & Doctor ===${NC}"

# --- PHASE 1: Dependency Check ---
echo -e "\n${CYAN}[1/4] Checking System Dependencies...${NC}"
DEPENDENCIES=("android-tools" "scrcpy" "tailscale" "wofi" "zenity")
TO_INSTALL=()

for pkg in "${DEPENDENCIES[@]}"; do
    if ! pacman -Qi "$pkg" &> /dev/null; then
        echo -e "${RED}MISSING:${NC} $pkg"
        TO_INSTALL+=("$pkg")
    else
        echo -e "${GREEN}FOUND:${NC} $pkg"
    fi
done

if [ ${#TO_INSTALL[@]} -ne 0 ]; then
    echo -e "\nInstalling missing packages (requires sudo)..."
    sudo pacman -S --noconfirm "${TO_INSTALL[@]}"
else
    echo "All packages are installed."
fi

# --- PHASE 2: Permission Checks ---
echo -e "\n${CYAN}[2/4] Verifying User Groups...${NC}"
# Arch requires user to be in 'adbusers' for USB access without sudo
if groups "$USER" | grep &>/dev/null 'adbusers'; then
    echo -e "${GREEN}User is in 'adbusers' group.${NC}"
else
    echo -e "${RED}User NOT in 'adbusers' group.${NC}"
    echo "Fixing permissions (requires sudo)..."
    sudo usermod -aG adbusers "$USER"
    echo "NOTE: You may need to log out and back in for this to take effect."
fi

# --- PHASE 3: Directory & Config Structure ---
echo -e "\n${CYAN}[3/4] Verifying Directory Structure...${NC}"
WORK_DIR="$HOME/Work/adb"
BIN_DIR="$HOME/.local/bin"
mkdir -p "$WORK_DIR" "$BIN_DIR" "$WORK_DIR/android-menu"

# Ensure devices.list exists
CONFIG_FILE="$WORK_DIR/devices.list"
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Creating default devices.list..."
    touch "$CONFIG_FILE"
fi

# --- PHASE 4: Symlink Repair ---
echo -e "\n${CYAN}[4/4] Repairing Symlinks...${NC}"

# Function to safely link and chmod
link_tool() {
    SRC="$1"
    DEST_NAME="$2"
    
    if [ -f "$SRC" ]; then
        chmod +x "$SRC"
        ln -sf "$SRC" "$BIN_DIR/$DEST_NAME"
        echo -e "${GREEN}LINKED:${NC} $DEST_NAME -> $SRC"
    else
        echo -e "${RED}MISSING SOURCE:${NC} $SRC (Cannot link)"
    fi
}

# Link all core tools
link_tool "$WORK_DIR/android-menu/android-menu.sh" "android-menu"
link_tool "$WORK_DIR/add-device.sh" "add-device"
link_tool "$WORK_DIR/repair-link.sh" "repair-link"

# Link any existing device scripts found in subfolders
find "$WORK_DIR" -name "*-ctl.sh" | while read script;
    do
    name=$(basename "$script" .sh)
    link_tool "$script" "$name"
done

echo -e "\n${GREEN}=== Setup Complete! ===${NC}"
echo "You can now press 'Super + Shift + I' to launch the menu."
Usage
Run this script anytime you move files, re-install your OS, or suspect a dependency is missing.

Bash

chmod +x ~/Work/adb/setup.sh
~/Work/adb/setup.sh

### Why this completes the package:
1.  **Arch-Aware:** It specifically checks the `adbusers` group, which is the #1 reason ADB fails on fresh Arch installs.
2.  **Dynamic Linking:** It finds *all* existing `*-ctl.sh` scripts you might have generated and ensures they are linked, even if you moved folders.
3.  **Safety:** It uses `ln -sf` so it never crashes if a link already existsâ€”it just updates it.

You now have a fully documented, self-healing, plug-and-play subsystem.
